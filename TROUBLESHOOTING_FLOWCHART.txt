â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              ğŸ” TROUBLESHOOTING FLOWCHART - Admin Claim Fix                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

START: Still getting PERMISSION_DENIED when updating order status?
â”‚
â”œâ”€â–º CHECK 1: What does Flutter log show for admin claim?
â”‚   â”‚
â”‚   â”œâ”€â–º "admin claim: true" âœ…
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â–º Problem is RULES, not claim
â”‚   â”‚       â”‚
â”‚   â”‚       â”œâ”€â–º Are rules deployed?
â”‚   â”‚       â”‚   â””â”€â–º Firebase Console â†’ Firestore â†’ Rules â†’ Check timestamp
â”‚   â”‚       â”‚       â””â”€â–º Re-deploy: Click "Publish" or run:
â”‚   â”‚       â”‚           firebase deploy --only firestore:rules
â”‚   â”‚       â”‚
â”‚   â”‚       â”œâ”€â–º Are rules in correct project?
â”‚   â”‚       â”‚   â””â”€â–º Check project name at top = pinksnap-mobile-app
â”‚   â”‚       â”‚
â”‚   â”‚       â”œâ”€â–º Does collection name match?
â”‚   â”‚       â”‚   â””â”€â–º Code uses: 'notifications'
â”‚   â”‚       â”‚   â””â”€â–º Rule matches: match /notifications/{notificationId}
â”‚   â”‚       â”‚   â””â”€â–º Must be exact match (case-sensitive!)
â”‚   â”‚       â”‚
â”‚   â”‚       â””â”€â–º Test with relaxed rule (temp):
â”‚   â”‚           match /notifications/{notificationId} {
â”‚   â”‚             allow create: if request.auth != null;
â”‚   â”‚           }
â”‚   â”‚           If this works â†’ rules syntax issue
â”‚   â”‚           Change back to: allow create: if isAdmin();
â”‚   â”‚
â”‚   â”œâ”€â–º "admin claim: null" or "admin claim: false" âŒ
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â–º Problem is CLAIM not set correctly
â”‚   â”‚       â”‚
â”‚   â”‚       â”œâ”€â–º Did script show "âœ… SUCCESS!"?
â”‚   â”‚       â”‚   â”œâ”€â–º NO â†’ Fix script errors first
â”‚   â”‚       â”‚   â””â”€â–º YES â†’ Continue below
â”‚   â”‚       â”‚
â”‚   â”‚       â”œâ”€â–º Is it the SAME Firebase project? ğŸš¨ MOST COMMON ISSUE
â”‚   â”‚       â”‚   â”‚
â”‚   â”‚       â”‚   â”œâ”€â–º Check script output:
â”‚   â”‚       â”‚   â”‚   Project ID: pinksnap-mobile-app  â† Must match!
â”‚   â”‚       â”‚   â”‚
â”‚   â”‚       â”‚   â”œâ”€â–º Check token log in Flutter:
â”‚   â”‚       â”‚   â”‚   aud: pinksnap-mobile-app  â† Must match!
â”‚   â”‚       â”‚   â”‚
â”‚   â”‚       â”‚   â””â”€â–º If different:
â”‚   â”‚       â”‚       â€¢ Downloaded service account key from WRONG project
â”‚   â”‚       â”‚       â€¢ Download key from correct project
â”‚   â”‚       â”‚       â€¢ Re-run: node set-admin-claim.js F8WAmOj9trhqw0atmaYVk58n8d03
â”‚   â”‚       â”‚
â”‚   â”‚       â”œâ”€â–º Did you use correct UID?
â”‚   â”‚       â”‚   â””â”€â–º Must be exactly: F8WAmOj9trhqw0atmaYVk58n8d03
â”‚   â”‚       â”‚   â””â”€â–º Check script output: "Found user: admin@pinksnap1.com"
â”‚   â”‚       â”‚
â”‚   â”‚       â”œâ”€â–º Did you sign out AND back in?
â”‚   â”‚       â”‚   â””â”€â–º Old tokens are cached!
â”‚   â”‚       â”‚   â””â”€â–º Must: Sign out â†’ Sign in (not just restart app)
â”‚   â”‚       â”‚
â”‚   â”‚       â””â”€â–º Force token refresh:
â”‚   â”‚           final user = FirebaseAuth.instance.currentUser;
â”‚   â”‚           final token = await user?.getIdTokenResult(true);
â”‚   â”‚           debugPrint("Force refresh admin: ${token?.claims?['admin']}");
â”‚   â”‚           
â”‚   â”‚           Still null? â†’ Go back to "SAME Firebase project" check above
â”‚   â”‚
â”‚   â””â”€â–º Log doesn't show anything about "admin claim" âŒ
â”‚       â”‚
â”‚       â””â”€â–º Flutter code not running token verification
â”‚           â”‚
â”‚           â”œâ”€â–º Check you're on latest code
â”‚           â”‚   â””â”€â–º lib/services/firebase_auth_service.dart
â”‚           â”‚   â””â”€â–º lib/controllers/auth_controller.dart
â”‚           â”‚
â”‚           â””â”€â–º Manually add after login:
â”‚               final token = await FirebaseAuth.instance.currentUser
â”‚                   ?.getIdTokenResult(true);
â”‚               debugPrint("Admin: ${token?.claims?['admin']}");
â”‚
â””â”€â–º SUCCESS CRITERIA:
    âœ… Flutter log shows: "admin claim: true"
    âœ… Script showed: "âœ… SUCCESS!" with correct project_id
    âœ… Order status update works
    âœ… No PERMISSION_DENIED errors
    âœ… Log shows: "Status update notification sent"

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          ğŸ¯ CRITICAL CHECKPOINTS                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before running script:
  â–¡ Downloaded serviceAccountKey.json from Firebase Console
  â–¡ Verified project name = pinksnap-mobile-app at top of console
  â–¡ File saved as serviceAccountKey.json in project root
  â–¡ Ran: npm install

After running script:
  â–¡ Saw "âœ… SUCCESS!" message
  â–¡ Script output shows: Project ID: pinksnap-mobile-app
  â–¡ Script output shows: Found user: admin@pinksnap1.com

Before testing in app:
  â–¡ Signed out completely
  â–¡ Signed in again
  â–¡ Saw "admin claim: true" in logs (NOT null)
  â–¡ Firestore rules deployed (check timestamp in console)

If claim = true but still errors:
  â–¡ Rules deployed to correct project (check project name)
  â–¡ Rules contain: function isAdmin()
  â–¡ Rules contain: match /notifications/{notificationId}
  â–¡ Rule has: allow create: if isAdmin();

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        ğŸš¨ TOP 3 MISTAKES TO AVOID                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. WRONG FIREBASE PROJECT (Most Common!)
   âŒ Downloaded service account key from different project
   âœ… Verify: project_id in serviceAccountKey.json = pinksnap-mobile-app

2. NOT SIGNING OUT/IN
   âŒ Just restarting app or refreshing
   âœ… Must: Sign out â†’ Sign in to get new token

3. RULES NOT DEPLOYED
   âŒ Edited rules locally but didn't deploy
   âœ… Must: Click "Publish" in console or run firebase deploy

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      ğŸ’¡ QUICK DIAGNOSTIC COMMANDS                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Check project ID in service account key:
  cat serviceAccountKey.json | grep project_id
  
Verify Node script syntax:
  node --check set-admin-claim.js
  
Check if Firebase CLI is installed:
  firebase --version
  
List Firebase projects:
  firebase projects:list
  
Deploy rules manually:
  firebase deploy --only firestore:rules

Force token refresh in Flutter (add temporarily):
  final user = FirebaseAuth.instance.currentUser;
  final token = await user?.getIdTokenResult(true);
  debugPrint("Project: ${token?.claims?['aud']}");  // Should be pinksnap-mobile-app
  debugPrint("Admin: ${token?.claims?['admin']}");   // Should be true

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           ğŸ“ STILL STUCK?                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Provide these details:
  1. Script output (entire output from node set-admin-claim.js)
  2. Flutter log showing token claims
  3. Firebase Console â†’ Firestore â†’ Rules (screenshot or copy rules)
  4. Exact error message from Flutter logs
  5. Output of: cat serviceAccountKey.json | grep project_id

The answer is in one of these - we just need to see which!
